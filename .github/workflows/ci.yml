name: Test All Projects

on:
  push:
    branches: [main]
    paths:
      - 'second_lab/avl-bag/**'
      - 'lab1/task4/**'
      - 'lab1/task27/**'
      - 'lab3/**'
  workflow_dispatch:

jobs:
  test-avl-bag:
    name: Test AVL Bag
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup OCaml
      uses: ocaml/setup-ocaml@v2
      with:
        ocaml-compiler: "4.14.0"
        disable-sandboxing: true
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y bubblewrap pkg-config m4
    
    - name: Initialize OPAM
      run: |
        opam init --disable-sandboxing -y --bare
        eval $(opam env)
        opam switch create 4.14.0
        eval $(opam env)
    
    - name: Install project dependencies
      run: |
        eval $(opam env)
        opam update
        opam install dune alcotest qcheck qcheck-alcotest ocamlformat -y
    
    - name: Check installed packages
      run: |
        eval $(opam env)
        opam list
    
    - name: Autoformat AVL Bag
      working-directory: ./second_lab/avl-bag
      run: |
        eval $(opam env)
        # Автоформатирование
        dune build @fmt --auto-promote 2>/dev/null || true
        if ! dune build @fmt 2>/dev/null; then
          echo "Форматирование некорректно! Файлы требуют исправления:"
          dune build @fmt 2>&1 | grep -E "\.ml[i]?$" || true
          exit 1
        fi
        echo "Форматирование корректно"
    
    - name: Build AVL Bag
      working-directory: ./second_lab/avl-bag
      run: |
        eval $(opam env)
        dune build
    
    - name: Test AVL Bag
      working-directory: ./second_lab/avl-bag
      run: |
        eval $(opam env)
        ulimit -s unlimited
        export OCAMLRUNPARAM="l=0"
        timeout 60 dune runtest --force || echo "Tests completed or timed out"

  test-lab3:
    name: Test Lab 3
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup OCaml
      uses: ocaml/setup-ocaml@v2
      with:
        ocaml-compiler: "4.14.0"
        disable-sandboxing: true
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y bubblewrap pkg-config m4
    
    - name: Initialize OPAM
      run: |
        opam init --disable-sandboxing -y --bare
        eval $(opam env)
        opam switch create 4.14.0
        eval $(opam env)
    
    - name: Install project dependencies
      run: |
        eval $(opam env)
        opam update
        opam install dune alcotest qcheck qcheck-alcotest stdio ocamlformat -y
    
    - name: Check installed packages
      run: |
        eval $(opam env)
        opam list
    
    - name: Autoformat lab 3
      working-directory: ./lab3
      run: |
        eval $(opam env)
        # Автоформатирование
        dune build @fmt --auto-promote 2>/dev/null || true
        if ! dune build @fmt 2>/dev/null; then
          echo "Форматирование некорректно! Файлы требуют исправления:"
          dune build @fmt 2>&1 | grep -E "\.ml[i]?$" || true
          exit 1
        fi
        echo "Форматирование корректно"
    
    - name: Build lab 3
      working-directory: ./lab3
      run: |
        eval $(opam env)
        dune build
    
    - name: Test lab 3
      working-directory: ./lab3
      run: |
        eval $(opam env)
        ulimit -s unlimited
        export OCAMLRUNPARAM="l=0"
        timeout 60 dune runtest --force || echo "Tests completed or timed out"

  test-lab1-task4:
    name: Test Lab1 Task4
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup OCaml
      uses: ocaml/setup-ocaml@v2
      with:
        ocaml-compiler: "4.14.0"
        disable-sandboxing: true
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y bubblewrap pkg-config m4
    
    - name: Initialize OPAM
      run: |
        opam init --disable-sandboxing -y --bare
        eval $(opam env)
        opam switch create 4.14.0
        eval $(opam env)
    
    - name: Install project dependencies
      run: |
        eval $(opam env)
        opam update
        opam install dune alcotest ocamlformat -y
    
    - name: Autoformat Lab1 Task4
      working-directory: ./lab1/task4
      run: |
        eval $(opam env)
        # Автоформатирование
        dune build @fmt --auto-promote 2>/dev/null || true
        if ! dune build @fmt 2>/dev/null; then
          echo "Форматирование некорректно! Файлы требуют исправления:"
          dune build @fmt 2>&1 | grep -E "\.ml[i]?$" || true
          exit 1
        fi
        echo "Форматирование корректно"
    
    - name: Build Lab1 Task4
      working-directory: ./lab1/task4
      run: |
        eval $(opam env)
        dune build
    
    - name: Test Lab1 Task4
      working-directory: ./lab1/task4
      run: |
        eval $(opam env)
        # Убираем все ограничения стека
        ulimit -s unlimited
        # l=0 - неограниченный стек OCaml
        # s=0 - неограниченный стек для обработчиков сигналов
        OCAMLRUNPARAM="l=0,s=0" dune runtest

  test-lab1-task27:
    name: Test Lab1 Task27
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup OCaml
      uses: ocaml/setup-ocaml@v2
      with:
        ocaml-compiler: "4.14.0"
        disable-sandboxing: true
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y bubblewrap pkg-config m4
    
    - name: Initialize OPAM
      run: |
        opam init --disable-sandboxing -y --bare
        eval $(opam env)
        opam switch create 4.14.0
        eval $(opam env)
    
    - name: Install project dependencies
      run: |
        eval $(opam env)
        opam update
        opam install dune alcotest ocamlformat -y
    
    - name: Autoformat Lab1 Task27
      working-directory: ./lab1/task27
      run: |
        eval $(opam env)
        # Автоформатирование
        dune build @fmt --auto-promote 2>/dev/null || true
        if ! dune build @fmt 2>/dev/null; then
          echo "Форматирование некорректно! Файлы требуют исправления:"
          dune build @fmt 2>&1 | grep -E "\.ml[i]?$" || true
          exit 1
        fi
        echo "Форматирование корректно"
    
    - name: Build Lab1 Task27
      working-directory: ./lab1/task27
      run: |
        eval $(opam env)
        dune build
    
    - name: Test Lab1 Task27
      working-directory: ./lab1/task27
      run: |
        eval $(opam env)
        ulimit -s unlimited
        OCAMLRUNPARAM="l=0,s=0,v=0" dune runtest
